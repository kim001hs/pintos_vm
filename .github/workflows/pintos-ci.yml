name: Pintos Test CI

on:
  pull_request:
  workflow_dispatch:

jobs:
  pintos-test:
    # Skip draft PRs
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.draft == false }}

    runs-on: ubuntu-22.04
    timeout-minutes: 60

    permissions:
      contents: read
      pull-requests: write

    steps:
      # ----------------------------
      # Checkout
      # ----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------
      # Install tools
      # ----------------------------
      - name: Install QEMU & build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-system-i386 \
            gcc g++ make perl python3
          sudo ln -sf /usr/bin/qemu-system-i386 /usr/bin/qemu
          qemu --version

      # ----------------------------
      # Activate Pintos environment
      # ----------------------------
      - name: Activate Pintos
        run: |
          if [ -f "./activate" ]; then
            source ./activate
          fi
          echo "$GITHUB_WORKSPACE/utils" >> $GITHUB_PATH

      # ----------------------------
      # Run Pintos Tests
      # ----------------------------
      - name: Run Pintos tests
        env:
          PINTOSOPTS: -v
        run: |
          set +e
          projects=("userprog")
          echo "## ðŸ§ª Pintos Test Results" > test-summary.md
          echo "" >> test-summary.md

          # Commit reference
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "**Commit:** \`${{ github.event.pull_request.head.sha }}\`" >> test-summary.md
          else
            echo "**Commit:** \`${{ github.sha }}\`" >> test-summary.md
          fi
          echo "" >> test-summary.md

          grand_pass=0
          grand_total=0

          for project in "${projects[@]}"; do
            echo "::group::Testing $project"

            if [ ! -d "$project" ]; then
              echo "### âš ï¸ Missing directory: $project" >> "$GITHUB_WORKSPACE/test-summary.md"
              echo "::endgroup::"
              continue
            fi

            cd "$project"
            make clean
            make || {
              echo "### âŒ Build failed: $project" >> "$GITHUB_WORKSPACE/test-summary.md"
              cd "$GITHUB_WORKSPACE"
              echo "::endgroup::"
              continue
            }

            cd build
            make check VERBOSE=1 || true

            result_files=$(find tests -name '*.result' | sort)
            total=$(echo "$result_files" | wc -l)

            if [ "$total" -eq 0 ]; then
              echo "### âš ï¸ No tests found in $project" >> "$GITHUB_WORKSPACE/test-summary.md"
              cd "$GITHUB_WORKSPACE"
              echo "::endgroup::"
              continue
            fi

            pass=0
            fail=0

            echo "### ðŸ“ $project" >> "$GITHUB_WORKSPACE/test-summary.md"
            echo "<details><summary><b>Test Cases ($total)</b></summary>" >> "$GITHUB_WORKSPACE/test-summary.md"

            for file in $result_files; do
              name=$(basename "$file" .result)
              if grep -q "PASS" "$file"; then
                echo "- âœ… \`$name\`" >> "$GITHUB_WORKSPACE/test-summary.md"
                pass=$((pass+1))
              else
                echo "- âŒ \`$name\`" >> "$GITHUB_WORKSPACE/test-summary.md"
                fail=$((fail+1))
              fi
            done

            echo "</details>" >> "$GITHUB_WORKSPACE/test-summary.md"
            echo "" >> "$GITHUB_WORKSPACE/test-summary.md"

            rate=$(awk "BEGIN {printf \"%.1f%%\", ($pass/$total)*100}")
            echo "**Summary:** $pass / $total passed ($rate)" >> "$GITHUB_WORKSPACE/test-summary.md"
            echo "" >> "$GITHUB_WORKSPACE/test-summary.md"

            grand_pass=$((grand_pass+pass))
            grand_total=$((grand_total+total))

            cd "$GITHUB_WORKSPACE"
            echo "::endgroup::"
          done

          if [ "$grand_total" -gt 0 ]; then
            rate=$(awk "BEGIN {printf \"%.1f%%\", ($grand_pass/$grand_total)*100}")
            echo "---" >> test-summary.md
            echo "## ðŸ“Š Overall Results" >> test-summary.md
            echo "**$grand_pass / $grand_total** tests passed ($rate)" >> test-summary.md
          fi

          echo "" >> test-summary.md
          echo "_Last updated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')_" >> test-summary.md

          cat test-summary.md >> "$GITHUB_STEP_SUMMARY"

      # ----------------------------
      # PR Comment Update
      # ----------------------------
      - name: Find existing comment
        if: ${{ github.event_name == 'pull_request' }}
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: 'ðŸ§ª Pintos Test Results'

      - name: Create or update PR comment
        if: ${{ github.event_name == 'pull_request' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: test-summary.md
          edit-mode: replace

      # ----------------------------
      # Upload artifacts
      # ----------------------------
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pintos-test-results
          path: |
            threads/build/tests/**/*.output
            threads/build/tests/**/*.result
            userprog/build/tests/**/*.output
            userprog/build/tests/**/*.result
            test-summary.md
          retention-days: 7
